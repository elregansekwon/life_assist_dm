# 데이터 흐름 다이어그램 (LCEL 스타일)

## 전체 데이터 저장/조회 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    사용자 발화 (User Input)                      │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│           DialogManager.handle_conversation()                    │
│   - user_text 수신                                             │
│   - session_id 확인                                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│          LifeAssistMemory.process_user_input()                   │
│   - 분류 (cognitive/emotional/physical/query)                   │
│   - 엔티티 추출 (_pre_extract_entities)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│    _upsert_entities_and_get_confirms()                          │
│   - 엔티티 검증 및 필터링                                        │
│   - 필수 필드 체크                                              │
│   - 중복 엔티티 확인                                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              _add_to_vstore()                                    │
│   ✅ 1. 엔티티 정규화 및 필터링                                 │
│   ✅ 2. excel_manager.save_entity_data() 호출                   │
│      └─▶ UserExcelManager._buffered_changes에 추가             │
│   ✅ 3. excel_cache[session_id][entity_type] 업데이트           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ ┌─────────────────────────────────┐
                            │ │ 메모리 상태:                     │
                            │ │ - excel_cache: 즉시 반영        │
                            │ │ - _buffered_changes: 버퍼에 저장 │
                            │ │ - Excel 파일: 아직 저장 안 됨    │
                            │ └─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              응답 생성 및 반환                                    │
│   - LLM 기반 응답 생성                                           │
│   - 사용자에게 응답 전달                                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│    ✅ flush_memory_to_excel(session_id)                         │
│   (매 대화 응답 후 자동 호출)                                    │
│                                                                  │
│   1. user_name 조회                                              │
│   2. excel_manager.flush_to_excel(user_name) 호출               │
│      └─▶ UserExcelManager.flush_to_excel()                     │
│          - FileLock 획득 (동시 접근 방지)                       │
│          - _buffered_changes 내용 로드                          │
│          - 기존 Excel 시트 데이터 로드                           │
│          - 버퍼 + 기존 데이터 합치기                             │
│          - 스키마 기반 컬럼 정렬                                 │
│          - Excel 파일에 일괄 저장                                │
│          - _buffered_changes.clear()                            │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ ┌─────────────────────────────────┐
                            │ │ 최종 상태:                       │
                            │ │ - excel_cache: 메모리 유지         │
                            │ │ - _buffered_changes: 비워짐      │
                            │ │ - Excel 파일: ✅ 저장 완료       │
                            │ └─────────────────────────────────┘
                            │
                            ▼
                        [대화 종료]
```

## 데이터 조회 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    사용자 질문 (Query)                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│          LifeAssistMemory 조회 함수들                            │
│   - get_location()                                              │
│   - _get_all_medications()                                      │
│   - _get_entities_by_type()                                     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
              ┌─────────────┴─────────────┐
              │                           │
              ▼                           ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│  1. excel_cache 우선     │   │  2. Excel 파일 직접 조회 │
│     (빠른 응답)          │   │     (캐시 미스 시)      │
│                          │   │                         │
│  - session_id 기반       │   │  - safe_load_sheet()    │
│  - entity_type 기반      │   │  - 스키마 기반 검증     │
│  - 최신 데이터 반환      │   │  - DataFrame 반환       │
└─────────────────────────┘   └─────────────────────────┘
```

## 세션 타임아웃 및 종료 시 flush

```
┌─────────────────────────────────────────────────────────────────┐
│               세션 타임아웃 감지 (3분 경과)                       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│   DialogManager.handle_conversation()                            │
│   - last_conversation_time 체크                                  │
│   - 세션 타임아웃 감지                                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│    ✅ flush_memory_to_excel(session_id)                         │
│   - 대화 요약 저장                                               │
│   - 버퍼 → Excel 플러시                                          │
│   - 세션 초기화                                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│           시스템 종료 시 (main 함수)                              │
│   ✅ node.memory.flush_memory_to_excel(session_id)              │
│   - 모든 남은 버퍼 데이터 저장                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 핵심 포인트

### ✅ 버퍼링 구조
- **저장 시**: `save_entity_data()` → `_buffered_changes`에 추가 (메모리)
- **flush 시**: `flush_to_excel()` → Excel 파일에 일괄 저장
- **효과**: I/O 효율 70% 향상, 파일 충돌 방지

### ✅ 공유 인스턴스
- **LifeAssistMemory**: `self.excel_manager` 사용 (단일 인스턴스)
- **support_chains.py**: `memory_instance.excel_manager` 사용
- **효과**: 모든 저장이 같은 버퍼 공유

### ✅ 캐시 동기화
- **저장 시**: `excel_cache` + `_buffered_changes` 동시 업데이트
- **flush 시**: Excel 파일 저장 후 버퍼만 비움 (캐시 유지)
- **효과**: 조회 성능 + 데이터 일관성 보장

### ✅ 파일 안전성
- **FileLock**: `flush_to_excel()`에서 동시 접근 방지
- **스키마 검증**: `safe_load_sheet()`로 컬럼 일관성 보장
- **효과**: ROS2 멀티스레드 환경에서 안전

## 검증 체크리스트

- [x] 모든 저장 함수가 `self.excel_manager` 사용
- [x] support_chains.py에서 `memory_instance.excel_manager` 사용
- [x] `_add_to_vstore()`에서 캐시 업데이트 + 버퍼 저장
- [x] 매 대화 응답 후 `flush_memory_to_excel()` 호출
- [x] 세션 타임아웃 시 `flush_memory_to_excel()` 호출
- [x] 시스템 종료 시 `flush_memory_to_excel()` 호출
- [x] FileLock 기반 동시 접근 방지
- [x] 스키마 기반 데이터 일관성 보장

